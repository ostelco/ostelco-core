plugins {
  id "org.jetbrains.kotlin.jvm" version "1.2.61"
  id "application"
  id "com.github.johnrengelman.shadow" version "2.0.4"
  id "idea"
}

sourceSets {
  test {
    java.srcDirs = ['src/test/kotlin']
  }

  integration {
    java.srcDirs = ['src/test/kotlin', 'src/integration-tests/kotlin']
    resources.srcDir 'src/integration-tests/resources'
    compileClasspath += main.output + test.output
    runtimeClasspath += main.output + test.output
  }
}

version = "1.12.0"

repositories {
  maven {
    url 'https://dl.bintray.com/palantir/releases' // docker-compose-rule is published on bintray
  }
}

dependencies {
  // interface module between prime and prime-modules
  implementation project(':prime-api')

  // prime-modules
  runtimeOnly project(':ocs')
  runtimeOnly project(':firebase-store')
  runtimeOnly project(':neo4j-store')
  runtimeOnly project(':pseudonym-server')
  runtimeOnly project(':client-api')
  runtimeOnly project(':admin-api')
  runtimeOnly project(':app-notifier')
  runtimeOnly project(':payment-processor')
  runtimeOnly project(':analytics-module')

  implementation "com.fasterxml.jackson.module:jackson-module-kotlin:$jacksonVersion"
  implementation "io.dropwizard:dropwizard-http2:$dropwizardVersion"
  implementation "io.dropwizard:dropwizard-json-logging:$dropwizardVersion"
  implementation 'com.google.guava:guava:25.1-jre'
  implementation 'org.dhatim:dropwizard-prometheus:2.2.0'

  testImplementation "io.dropwizard:dropwizard-testing:$dropwizardVersion"
  testImplementation 'org.mockito:mockito-core:2.18.3'
  testImplementation 'com.lmax:disruptor:3.4.2'
  testImplementation 'com.palantir.docker.compose:docker-compose-rule-junit4:0.34.0'
  testImplementation 'org.dhatim:dropwizard-prometheus:2.2.0'

  integrationImplementation "io.dropwizard:dropwizard-testing:$dropwizardVersion"
  integrationImplementation 'org.mockito:mockito-core:2.18.3'
  integrationImplementation 'com.lmax:disruptor:3.4.2'
  integrationImplementation 'com.palantir.docker.compose:docker-compose-rule-junit4:0.34.0'
}

configurations {
  integration
  integrationImplementation.extendsFrom implementation
  integrationImplementation.extendsFrom runtime
  integrationImplementation.extendsFrom runtimeOnly
}

task integration(type: Test, description: 'Runs the integration tests.', group: 'Verification') {
  environment("GOOGLE_APPLICATION_CREDENTIALS", "config/pantel-prod.json")
  testClassesDirs = sourceSets.integration.output.classesDirs
  classpath = sourceSets.integration.runtimeClasspath
}

if (System.getenv("BUILD_ENV") != "CI_CD") {
  build.dependsOn integration
}

shadowJar {
  mainClassName = 'org.ostelco.prime.PrimeApplicationKt'
  mergeServiceFiles()
  classifier = "uber"
  zip64 true
  version = null
}

test {
  testLogging {
    exceptionFormat = 'full'
    events "PASSED", "FAILED", "SKIPPED"
  }
}

idea {
  module {
    testSourceDirs += file('src/integration-tests/kotlin')
  }
}