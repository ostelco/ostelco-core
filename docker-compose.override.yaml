version: "3.3"

services:
  prime:
    container_name: prime
    build:
      context: prime
      dockerfile: Dockerfile.test
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/secret/pantel-prod.json
      - PUBSUB_EMULATOR_HOST=pubsub-emulator:8085
      - PUBSUB_PROJECT_ID=pantel-2decb
    ports:
      - "9090:8080"
    depends_on:
      - "pubsub-emulator"
    networks:
      net:
        aliases:
          - "prime"
        ipv4_address: 172.16.238.4
      default:

  ocsgw:
    depends_on:
      - "prime"
    command: ["./wait_for_prime.sh"]
    networks:
      net:
        aliases:
          - "ocsgw"
        ipv4_address: 172.16.238.3

  ext-pgw:
    container_name: ext-pgw
    build: ext-pgw
    depends_on:
      - "ocsgw"
    command: ["./wait_for_ocsgw.sh"]
    networks:
      net:
        aliases:
          - "ext-pgw"
        ipv4_address: 172.16.238.2

  pseudonym-server:
    container_name: pseudonym-server
    build: pseudonym-server
    ports:
      - "8090:8080"
    environment:
      - DATASTORE_EMULATOR_HOST=localhost:9090
      - DATASTORE_PROJECT_ID=pantel-2decb
      - PUBSUB_EMULATOR_HOST=localhost:9080
      - PUBSUB_PROJECT_ID=pantel-2decb
      - LOCAL_TESTING=true
    command: ["/bin/bash", "./wait_for_emulators.sh"]

  pubsub-emulator:
    container_name: pubsub-emulator
    image: knarz/pubsub-emulator

  gpubsub-emulator:
    container_name: gpubsub-emulator
    image: google/cloud-sdk
    command: ["gcloud", "beta", "emulators", "pubsub", "start", "--host-port=0.0.0.0:8085"]

  datastore-emulator:
    container_name: datastore-emulator
    image: google/cloud-sdk
    expose:
      - "8081"
    environment:
      - CLOUDSDK_CORE_PROJECT=pantel-2decb
      - DATASTORE_DATASET=pantel-2decb
    command: ["gcloud", "beta", "emulators", "datastore", "start", "--host-port=0.0.0.0:8081"]

  ext-auth-provider:
    container_name: ext-auth-provider
    build: ext-auth-provider

  acceptance-tests:
    container_name: acceptance-tests
    build: acceptance-tests
    depends_on:
      - "prime"
    command: ["./wait_for_prime.sh"]
    environment:
      - PRIME_SOCKET=prime:8080

networks:
  net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.16.238.0/24
