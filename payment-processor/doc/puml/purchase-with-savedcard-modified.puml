@startuml

actor Client
participant Client

box "Prime"
    participant "client-api"
    participant "payment-processor"
    participant OCS
    participant DAO
end box
participant Stripe

activate Client
    Client -> "client-api" : Get saved sources
    activate "client-api"
    "client-api" -> Client : {list of sources}
    deactivate "client-api"
    note right : See "list-card" flow diagram

    Client -> Client : Choose source for payment

    Client -> "client-api": POST /products {sku, sourceId}
    activate "client-api"

    "client-api" -> "payment-processor" : purchaseProduct(name, sku, sourceId)
    activate "payment-processor"

    "payment-processor" -> DAO : getStripeCustomerId(name)
    activate DAO
    DAO -> "payment-processor" : {customerId}
    deactivate DAO

    "payment-processor" -> DAO : getProduct(sku)
    activate DAO
    DAO -> "payment-processor" : {product}
    deactivate DAO

    alt successful case
        "payment-processor" -> Stripe : POST /v1/charges {customerId, sourceId, product.amount, product.currency, product.description}
        activate Stripe
        Stripe -> "payment-processor" : {chargeInfo}
        deactivate Stripe

        "payment-processor" -> DAO: recordChargeInfo(name, chargeInfo)
        activate DAO
        DAO -> "payment-processor" : {result}
        deactivate DAO

        "payment-processor" -> OCS : updateBucket(name, product.size)
        activate OCS
        OCS -> "payment-processor" : {result}
        deactivate OCS

    else error
         note right of "payment-processor" : Unroll charge with Stripe etc. (TBD)

    end

    "payment-processor" -> "client-api" : {result}
    deactivate "payment-processor"

    "client-api" -> Client : {result}
    deactivate "client-api"

deactivate Client

@enduml
