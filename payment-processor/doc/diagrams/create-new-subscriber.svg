<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="860px" preserveAspectRatio="none" style="width:1183px;height:860px;" version="1.1" viewBox="0 0 1183 860" width="1183px" zoomAndPan="magnify"><defs><filter height="300%" id="f1m4p98il33ker" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="845.0547" style="stroke: #A80036; stroke-width: 1.0;" width="600" x="216.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="495" y="16.0669">Prime</text><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="648.4609" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="526.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="257.5" y="217.8281"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="414.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="479.5" y="301.2266"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="97.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="782.5" y="455.8906"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="928.5" y="159.5625"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="72.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="928.5" y="354.4922"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="928.5" y="582.4219"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="342.1328" style="stroke: #000000; stroke-width: 2.0;" width="775" x="396.5" y="316.2266"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="775" x="396.5" y="604.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="31" x2="31" y1="86.2969" y2="762.7578"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="262.5" x2="262.5" y1="86.2969" y2="762.7578"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="484.5" x2="484.5" y1="86.2969" y2="762.7578"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="596.5" x2="596.5" y1="86.2969" y2="762.7578"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="787.5" x2="787.5" y1="86.2969" y2="762.7578"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="933.5" x2="933.5" y1="86.2969" y2="762.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="82.9951">Client</text><ellipse cx="31.5" cy="13" fill="#FEFECE" filter="url(#f1m4p98il33ker)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,21 L31.5,48 M18.5,29 L44.5,29 M31.5,48 L18.5,63 M31.5,48 L44.5,63 " fill="none" filter="url(#f1m4p98il33ker)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="774.7529">Client</text><ellipse cx="31.5" cy="788.0547" fill="#FEFECE" filter="url(#f1m4p98il33ker)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,796.0547 L31.5,823.0547 M18.5,804.0547 L44.5,804.0547 M31.5,823.0547 L18.5,838.0547 M31.5,823.0547 L44.5,838.0547 " fill="none" filter="url(#f1m4p98il33ker)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1m4p98il33ker)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="220.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="227.5" y="70.9951">client-api</text><rect fill="#FEFECE" filter="url(#f1m4p98il33ker)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="220.5" y="761.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="227.5" y="781.7529">client-api</text><rect fill="#FEFECE" filter="url(#f1m4p98il33ker)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="406.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="413.5" y="70.9951">payment-processor</text><rect fill="#FEFECE" filter="url(#f1m4p98il33ker)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="406.5" y="761.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="413.5" y="781.7529">payment-processor</text><rect fill="#FEFECE" filter="url(#f1m4p98il33ker)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="572.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="579.5" y="70.9951">OCS</text><rect fill="#FEFECE" filter="url(#f1m4p98il33ker)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="572.5" y="761.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="579.5" y="781.7529">OCS</text><rect fill="#FEFECE" filter="url(#f1m4p98il33ker)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="762.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="769.5" y="70.9951">DAO</text><rect fill="#FEFECE" filter="url(#f1m4p98il33ker)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="762.5" y="761.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="769.5" y="781.7529">DAO</text><rect fill="#FEFECE" filter="url(#f1m4p98il33ker)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="903.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="910.5" y="70.9951">Stripe</text><rect fill="#FEFECE" filter="url(#f1m4p98il33ker)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="903.5" y="761.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="910.5" y="781.7529">Stripe</text><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="648.4609" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="526.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="257.5" y="217.8281"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="414.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="479.5" y="301.2266"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="97.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="782.5" y="455.8906"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="928.5" y="159.5625"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="72.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="928.5" y="354.4922"/><rect fill="#FFFFFF" filter="url(#f1m4p98il33ker)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="928.5" y="582.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="78.5" y1="117.4297" y2="117.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="78.5" x2="78.5" y1="117.4297" y2="130.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="37.5" x2="78.5" y1="130.4297" y2="130.4297"/><polygon fill="#A80036" points="47.5,126.4297,37.5,130.4297,47.5,134.4297,43.5,130.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="43.5" y="112.3638">Collecting payment information</text><polygon fill="#A80036" points="916.5,155.5625,926.5,159.5625,916.5,163.5625,920.5,159.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="922.5" y1="159.5625" y2="159.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="43.5" y="154.4966">Create Source</text><polygon fill="#A80036" points="47.5,184.6953,37.5,188.6953,47.5,192.6953,43.5,188.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="41.5" x2="932.5" y1="188.6953" y2="188.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="53.5" y="183.6294">{sourceId}</text><polygon fill="#A80036" points="245.5,213.8281,255.5,217.8281,245.5,221.8281,249.5,217.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="251.5" y1="217.8281" y2="217.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="43.5" y="212.7622">POST /profile {sourceId}</text><path d="M272,230.8281 L272,270.8281 L601,270.8281 L601,240.8281 L591,230.8281 L272,230.8281 " fill="#FBFB77" filter="url(#f1m4p98il33ker)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M591,230.8281 L591,240.8281 L601,240.8281 L591,230.8281 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="278" y="247.895">{name} identifies the user (from Oauth2 auth.)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="278" y="263.0278">and is equivalent to the users email address</text><polygon fill="#A80036" points="467.5,297.2266,477.5,301.2266,467.5,305.2266,471.5,301.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="267.5" x2="473.5" y1="301.2266" y2="301.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="274.5" y="296.1606">createProfile(name, sourceId)</text><path d="M396.5,316.2266 L460.5,316.2266 L460.5,323.2266 L450.5,333.2266 L396.5,333.2266 L396.5,316.2266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="342.1328" style="stroke: #000000; stroke-width: 2.0;" width="775" x="396.5" y="316.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="411.5" y="329.2935">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="475.5" y="328.437">[successful case]</text><polygon fill="#A80036" points="916.5,350.4922,926.5,354.4922,916.5,358.4922,920.5,354.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="489.5" x2="922.5" y1="354.4922" y2="354.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="420" x="496.5" y="349.4263">POST /v1/customers {name} (Create new subscriber with Stripe)</text><polygon fill="#A80036" points="500.5,379.625,490.5,383.625,500.5,387.625,496.5,383.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="494.5" x2="927.5" y1="383.625" y2="383.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="506.5" y="378.5591">{customerId}</text><polygon fill="#A80036" points="916.5,408.7578,926.5,412.7578,916.5,416.7578,920.5,412.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="489.5" x2="922.5" y1="412.7578" y2="412.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="496.5" y="407.6919">POST /v1/customers/{customerId}/sources {sourceId}</text><polygon fill="#A80036" points="500.5,422.7578,490.5,426.7578,500.5,430.7578,496.5,426.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="494.5" x2="932.5" y1="426.7578" y2="426.7578"/><polygon fill="#A80036" points="770.5,451.8906,780.5,455.8906,770.5,459.8906,774.5,455.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="489.5" x2="776.5" y1="455.8906" y2="455.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="496.5" y="450.8247">createProfile(name, customerId, sourceId)</text><polygon fill="#A80036" points="500.5,486.0234,490.5,490.0234,500.5,494.0234,496.5,490.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="494.5" x2="781.5" y1="490.0234" y2="490.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="506.5" y="484.9575">{result}</text><path d="M797,468.8906 L797,493.8906 L1157,493.8906 L1157,478.8906 L1147,468.8906 L797,468.8906 " fill="#FBFB77" filter="url(#f1m4p98il33ker)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1147,468.8906 L1147,478.8906 L1157,478.8906 L1147,468.8906 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="803" y="485.9575">{sourceId} will be saved as default payment source</text><polygon fill="#A80036" points="770.5,520.1563,780.5,524.1563,770.5,528.1563,774.5,524.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="489.5" x2="776.5" y1="524.1563" y2="524.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="496.5" y="519.0903">getDefaultPlan(name)</text><polygon fill="#A80036" points="500.5,549.2891,490.5,553.2891,500.5,557.2891,496.5,553.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="494.5" x2="786.5" y1="553.2891" y2="553.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="506.5" y="548.2231">{planId}</text><polygon fill="#A80036" points="916.5,578.4219,926.5,582.4219,916.5,586.4219,920.5,582.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="489.5" x2="922.5" y1="582.4219" y2="582.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="496.5" y="577.356">POST v1/subscriptions {planId}, {customerId}</text><polygon fill="#A80036" points="500.5,592.4219,490.5,596.4219,500.5,600.4219,496.5,596.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="494.5" x2="932.5" y1="596.4219" y2="596.4219"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="396.5" x2="1171.5" y1="605.4219" y2="605.4219"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="40" x="401.5" y="615.6323">[error]</text><path d="M494,624.2266 L494,649.2266 L745,649.2266 L745,634.2266 L735,624.2266 L494,624.2266 " fill="#FBFB77" filter="url(#f1m4p98il33ker)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M735,624.2266 L735,634.2266 L745,634.2266 L735,624.2266 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="500" y="641.2935">Unroll charge with Stripe etc. (TBD)</text><polygon fill="#A80036" points="584.5,682.4922,594.5,686.4922,584.5,690.4922,588.5,686.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="489.5" x2="590.5" y1="686.4922" y2="686.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="496.5" y="681.4263">Notify OCS</text><polygon fill="#A80036" points="278.5,711.625,268.5,715.625,278.5,719.625,274.5,715.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272.5" x2="483.5" y1="715.625" y2="715.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="284.5" y="710.5591">{result}</text><polygon fill="#A80036" points="42.5,740.7578,32.5,744.7578,42.5,748.7578,38.5,744.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="261.5" y1="744.7578" y2="744.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="48.5" y="739.6919">{result}</text><!--
@startuml

actor Client
participant Client

box "Prime"
    participant "client-api"
    participant "payment-processor"
    participant OCS
    participant DAO
end box
participant Stripe

activate Client
    Client -> Client : Collecting payment information

    Client -> Stripe : Create Source
    activate Stripe
    Stripe -> Client : {sourceId}
    deactivate Stripe

    Client -> "client-api": POST /profile {sourceId}
    activate "client-api"
    note right of "client-api"
       {name} identifies the user (from Oauth2 auth.)
       and is equivalent to the users email address
    end note

    "client-api" -> "payment-processor" : createProfile(name, sourceId)
    activate "payment-processor"

    alt successful case
       "payment-processor" -> Stripe : POST /v1/customers {name} (Create new subscriber with Stripe)
       activate Stripe
       "Stripe" -> "payment-processor" : {customerId}

       "payment-processor" -> Stripe : POST /v1/customers/{customerId}/sources {sourceId}
       "Stripe" -> "payment-processor"
       deactivate Stripe

       "payment-processor" -> DAO : createProfile(name, customerId, sourceId)
       activate DAO
       DAO -> "payment-processor" : {result}
       note right : {sourceId} will be saved as default payment source

       "payment-processor" -> DAO : getDefaultPlan(name)
       DAO -> "payment-processor" : {planId}
       deactivate DAO

       "payment-processor" -> Stripe : POST v1/subscriptions {planId}, {customerId}
       activate Stripe
       "Stripe" -> "payment-processor"
       deactivate Stripe

    else error
       note right of "payment-processor" : Unroll charge with Stripe etc. (TBD)

    end

    "payment-processor" -> OCS : Notify OCS

    "payment-processor" -> "client-api" : {result}
    deactivate "payment-processor"

    "client-api" -> Client : {result}
    deactivate "client-api"

deactivate Client

@enduml

PlantUML version 1.2018.08(Sun Jun 24 14:31:00 CEST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_171-8u171-b11-0ubuntu0.17.10.1-b11
Operating System: Linux
OS Version: 4.13.0-46-generic
Default Encoding: UTF-8
Language: nb
Country: NO
--></g></svg>