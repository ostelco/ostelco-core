<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1016px" preserveAspectRatio="none" style="width:1341px;height:1016px;" version="1.1" viewBox="0 0 1341 1016" width="1341px" zoomAndPan="magnify"><defs><filter height="300%" id="fufgb7bl9s6f3" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="1001.8516" style="stroke: #A80036; stroke-width: 1.0;" width="772" x="216.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="581" y="16.0669">Prime</text><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="805.2578" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="683.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="257.5" y="217.8281"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="256.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="609.5" y="487.1563"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="895.5" y="684.9531"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="954.5" y="359.4922"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="34.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="954.5" y="833.2891"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1082.5" y="159.5625"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="72.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1082.5" y="540.4219"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1082.5" y="641.8203"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="303" style="stroke: #000000; stroke-width: 2.0;" width="917" x="210.5" y="502.1563"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="917" x="210.5" y="751.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="31" x2="31" y1="86.2969" y2="919.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="262.5" x2="262.5" y1="86.2969" y2="919.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="614.5" x2="614.5" y1="86.2969" y2="919.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="900.5" x2="900.5" y1="86.2969" y2="919.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="959.5" x2="959.5" y1="86.2969" y2="919.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1087.5" x2="1087.5" y1="86.2969" y2="919.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="82.9951">Client</text><ellipse cx="31.5" cy="13" fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,21 L31.5,48 M18.5,29 L44.5,29 M31.5,48 L18.5,63 M31.5,48 L44.5,63 " fill="none" filter="url(#fufgb7bl9s6f3)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="931.5498">Client</text><ellipse cx="31.5" cy="944.8516" fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,952.8516 L31.5,979.8516 M18.5,960.8516 L44.5,960.8516 M31.5,979.8516 L18.5,994.8516 M31.5,979.8516 L44.5,994.8516 " fill="none" filter="url(#fufgb7bl9s6f3)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="220.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="227.5" y="70.9951">client-api</text><rect fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="220.5" y="918.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="227.5" y="938.5498">client-api</text><rect fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="536.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="543.5" y="70.9951">payment-processor</text><rect fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="536.5" y="918.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="543.5" y="938.5498">payment-processor</text><rect fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="876.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="883.5" y="70.9951">OCS</text><rect fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="876.5" y="918.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="883.5" y="938.5498">OCS</text><rect fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="934.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="941.5" y="70.9951">DAO</text><rect fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="934.5" y="918.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="941.5" y="938.5498">DAO</text><rect fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="1057.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1064.5" y="70.9951">Stripe</text><rect fill="#FEFECE" filter="url(#fufgb7bl9s6f3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="1057.5" y="918.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1064.5" y="938.5498">Stripe</text><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="805.2578" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="683.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="257.5" y="217.8281"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="256.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="609.5" y="487.1563"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="895.5" y="684.9531"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="954.5" y="359.4922"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="34.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="954.5" y="833.2891"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1082.5" y="159.5625"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="72.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1082.5" y="540.4219"/><rect fill="#FFFFFF" filter="url(#fufgb7bl9s6f3)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1082.5" y="641.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="78.5" y1="117.4297" y2="117.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="78.5" x2="78.5" y1="117.4297" y2="130.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="37.5" x2="78.5" y1="130.4297" y2="130.4297"/><polygon fill="#A80036" points="47.5,126.4297,37.5,130.4297,47.5,134.4297,43.5,130.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="43.5" y="112.3638">Collecting payment information</text><polygon fill="#A80036" points="1070.5,155.5625,1080.5,159.5625,1070.5,163.5625,1074.5,159.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="1076.5" y1="159.5625" y2="159.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="43.5" y="154.4966">Create Source</text><polygon fill="#A80036" points="47.5,184.6953,37.5,188.6953,47.5,192.6953,43.5,188.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="41.5" x2="1086.5" y1="188.6953" y2="188.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="53.5" y="183.6294">{sourceId}</text><polygon fill="#A80036" points="245.5,213.8281,255.5,217.8281,245.5,221.8281,249.5,217.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="251.5" y1="217.8281" y2="217.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="43.5" y="212.7622">POST /profile {sourceId}</text><path d="M272,230.8281 L272,270.8281 L601,270.8281 L601,240.8281 L591,230.8281 L272,230.8281 " fill="#FBFB77" filter="url(#fufgb7bl9s6f3)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M591,230.8281 L591,240.8281 L601,240.8281 L591,230.8281 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="278" y="247.895">{name} identifies the user (from Oauth2 auth.)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="278" y="263.0278">and is equivalent to the users email address</text><polygon fill="#A80036" points="947.5,297.2266,957.5,301.2266,947.5,305.2266,951.5,301.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="267.5" x2="953.5" y1="301.2266" y2="301.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="274.5" y="296.1606">getDefaultPlan(name)</text><polygon fill="#A80036" points="278.5,326.3594,268.5,330.3594,278.5,334.3594,274.5,330.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272.5" x2="958.5" y1="330.3594" y2="330.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="284.5" y="325.2935">{planId}</text><polygon fill="#A80036" points="942.5,355.4922,952.5,359.4922,942.5,363.4922,946.5,359.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="267.5" x2="948.5" y1="359.4922" y2="359.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="274.5" y="354.4263">getRecurringProduct(planId)</text><polygon fill="#A80036" points="278.5,384.625,268.5,388.625,278.5,392.625,274.5,388.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272.5" x2="958.5" y1="388.625" y2="388.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="284.5" y="383.5591">{product}</text><path d="M272,401.625 L272,456.625 L606,456.625 L606,411.625 L596,401.625 L272,401.625 " fill="#FBFB77" filter="url(#fufgb7bl9s6f3)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M596,401.625 L596,411.625 L606,411.625 L596,401.625 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="278" y="418.6919">The {customer} object contains the information</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="278" y="433.8247">required for registering the user with a payment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="278" y="448.9575">service (received from client)</text><polygon fill="#A80036" points="597.5,483.1563,607.5,487.1563,597.5,491.1563,601.5,487.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="267.5" x2="603.5" y1="487.1563" y2="487.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="274.5" y="482.0903">createPaymentProfile(customer, sourceId, planId)</text><path d="M210.5,502.1563 L274.5,502.1563 L274.5,509.1563 L264.5,519.1563 L210.5,519.1563 L210.5,502.1563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="303" style="stroke: #000000; stroke-width: 2.0;" width="917" x="210.5" y="502.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="225.5" y="515.2231">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="289.5" y="514.3667">[successful case]</text><polygon fill="#A80036" points="1070.5,536.4219,1080.5,540.4219,1070.5,544.4219,1074.5,540.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="619.5" x2="1076.5" y1="540.4219" y2="540.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="444" x="626.5" y="535.356">POST /v1/customers {customer} (Create new subscriber with Stripe)</text><polygon fill="#A80036" points="630.5,565.5547,620.5,569.5547,630.5,573.5547,626.5,569.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="624.5" x2="1081.5" y1="569.5547" y2="569.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="636.5" y="564.4888">{paymentId}</text><polygon fill="#A80036" points="1070.5,594.6875,1080.5,598.6875,1070.5,602.6875,1074.5,598.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="619.5" x2="1076.5" y1="598.6875" y2="598.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="349" x="626.5" y="593.6216">POST /v1/customers/{paymentId}/sources {sourceId}</text><polygon fill="#A80036" points="630.5,608.6875,620.5,612.6875,630.5,616.6875,626.5,612.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="624.5" x2="1086.5" y1="612.6875" y2="612.6875"/><polygon fill="#A80036" points="1070.5,637.8203,1080.5,641.8203,1070.5,645.8203,1074.5,641.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="619.5" x2="1076.5" y1="641.8203" y2="641.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="626.5" y="636.7544">POST v1/subscriptions {planId}, {paymentId}</text><polygon fill="#A80036" points="630.5,651.8203,620.5,655.8203,630.5,659.8203,626.5,655.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="624.5" x2="1086.5" y1="655.8203" y2="655.8203"/><polygon fill="#A80036" points="883.5,680.9531,893.5,684.9531,883.5,688.9531,887.5,684.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="619.5" x2="889.5" y1="684.9531" y2="684.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="626.5" y="679.8872">updateBucket(paymentId, product.size)</text><polygon fill="#A80036" points="630.5,710.0859,620.5,714.0859,630.5,718.0859,626.5,714.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="624.5" x2="899.5" y1="714.0859" y2="714.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="636.5" y="709.02">{result}</text><polygon fill="#A80036" points="278.5,739.2188,268.5,743.2188,278.5,747.2188,274.5,743.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272.5" x2="613.5" y1="743.2188" y2="743.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="284.5" y="738.1528">{paymentId}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="210.5" x2="1127.5" y1="752.2188" y2="752.2188"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="40" x="215.5" y="762.4292">[error]</text><path d="M619,771.0234 L619,796.0234 L870,796.0234 L870,781.0234 L860,771.0234 L619,771.0234 " fill="#FBFB77" filter="url(#fufgb7bl9s6f3)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M860,771.0234 L860,781.0234 L870,781.0234 L860,771.0234 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="625" y="788.0903">Unroll charge with Stripe etc. (TBD)</text><polygon fill="#A80036" points="942.5,829.2891,952.5,833.2891,942.5,837.2891,946.5,833.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="267.5" x2="948.5" y1="833.2891" y2="833.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="274.5" y="828.2231">createProfile(name, paymentId, sourceId)</text><polygon fill="#A80036" points="278.5,863.4219,268.5,867.4219,278.5,871.4219,274.5,867.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272.5" x2="958.5" y1="867.4219" y2="867.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="284.5" y="862.356">{result}</text><path d="M969,846.2891 L969,871.2891 L1329,871.2891 L1329,856.2891 L1319,846.2891 L969,846.2891 " fill="#FBFB77" filter="url(#fufgb7bl9s6f3)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1319,846.2891 L1319,856.2891 L1329,856.2891 L1319,846.2891 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="975" y="863.356">{sourceId} will be saved as default payment source</text><polygon fill="#A80036" points="42.5,897.5547,32.5,901.5547,42.5,905.5547,38.5,901.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="261.5" y1="901.5547" y2="901.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="48.5" y="896.4888">{result}</text><!--
@startuml

actor Client
participant Client

box "Prime"
    participant "client-api"
    participant "payment-processor"
    participant OCS
    participant DAO
end box
participant Stripe

activate Client
    Client -> Client : Collecting payment information

    Client -> Stripe : Create Source
    activate Stripe
    Stripe -> Client : {sourceId}
    deactivate Stripe

    Client -> "client-api": POST /profile {sourceId}
    activate "client-api"
    note right of "client-api"
       {name} identifies the user (from Oauth2 auth.)
       and is equivalent to the users email address
    end note

    "client-api" -> DAO : getDefaultPlan(name)
    DAO -> "client-api" : {planId}
    deactivate DAO

    "client-api" -> DAO : getRecurringProduct(planId)
    activate DAO
    DAO -> "client-api" : {product}
    deactivate DAO

    note right of "client-api"
       The {customer} object contains the information
       required for registering the user with a payment
       service (received from client)
    end note

    "client-api" -> "payment-processor" : createPaymentProfile(customer, sourceId, planId)
    activate "payment-processor"

    alt successful case
        "payment-processor" -> Stripe : POST /v1/customers {customer} (Create new subscriber with Stripe)
        activate Stripe
        "Stripe" -> "payment-processor" : {paymentId}

        "payment-processor" -> Stripe : POST /v1/customers/{paymentId}/sources {sourceId}
        "Stripe" -> "payment-processor"
        deactivate Stripe

        "payment-processor" -> Stripe : POST v1/subscriptions {planId}, {paymentId}
        activate Stripe
        "Stripe" -> "payment-processor"
        deactivate Stripe

        "payment-processor" -> OCS : updateBucket(paymentId, product.size)
        activate OCS
        OCS -> "payment-processor" : {result}
        deactivate OCS

        "payment-processor" -> "client-api" : {paymentId}
        deactivate "payment-processor"

    else error
       note right of "payment-processor" : Unroll charge with Stripe etc. (TBD)

    end

    "client-api" -> DAO : createProfile(name, paymentId, sourceId)
    activate DAO
    DAO -> "client-api" : {result}
    deactivate DAO
    note right : {sourceId} will be saved as default payment source

    "client-api" -> Client : {result}
    deactivate "client-api"

deactivate Client

@enduml

PlantUML version 1.2018.08(Sun Jun 24 14:31:00 CEST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_171-8u171-b11-0ubuntu0.17.10.1-b11
Operating System: Linux
OS Version: 4.13.0-46-generic
Default Encoding: UTF-8
Language: nb
Country: NO
--></g></svg>