<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="930px" preserveAspectRatio="none" style="width:1246px;height:930px;" version="1.1" viewBox="0 0 1246 930" width="1246px" zoomAndPan="magnify"><defs><filter height="300%" id="f146e7nywmc2wu" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="915.5859" style="stroke: #A80036; stroke-width: 1.0;" width="757" x="155.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="512.5" y="16.0669">Prime</text><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="718.9922" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="655.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="196.5" y="159.5625"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="314.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="533.5" y="472.0234"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="819.5" y="666.9531"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878.5" y="242.9609"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878.5" y="355.4922"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878.5" y="413.7578"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="41.6992" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878.5" y="583.5547"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1189.5" y="525.2891"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="271" style="stroke: #000000; stroke-width: 2.0;" width="784" x="450.5" y="487.0234"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="784" x="450.5" y="704.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="31" x2="31" y1="86.2969" y2="833.2891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="201.5" x2="201.5" y1="86.2969" y2="833.2891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="538.5" x2="538.5" y1="86.2969" y2="833.2891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="824.5" x2="824.5" y1="86.2969" y2="833.2891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="883.5" x2="883.5" y1="86.2969" y2="833.2891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1194.5" x2="1194.5" y1="86.2969" y2="833.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="82.9951">Client</text><ellipse cx="31.5" cy="13" fill="#FEFECE" filter="url(#f146e7nywmc2wu)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,21 L31.5,48 M18.5,29 L44.5,29 M31.5,48 L18.5,63 M31.5,48 L44.5,63 " fill="none" filter="url(#f146e7nywmc2wu)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="845.2842">Client</text><ellipse cx="31.5" cy="858.5859" fill="#FEFECE" filter="url(#f146e7nywmc2wu)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,866.5859 L31.5,893.5859 M18.5,874.5859 L44.5,874.5859 M31.5,893.5859 L18.5,908.5859 M31.5,893.5859 L44.5,908.5859 " fill="none" filter="url(#f146e7nywmc2wu)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f146e7nywmc2wu)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="159.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="166.5" y="70.9951">client-api</text><rect fill="#FEFECE" filter="url(#f146e7nywmc2wu)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="159.5" y="832.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="166.5" y="852.2842">client-api</text><rect fill="#FEFECE" filter="url(#f146e7nywmc2wu)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="460.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="467.5" y="70.9951">payment-processor</text><rect fill="#FEFECE" filter="url(#f146e7nywmc2wu)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="460.5" y="832.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="467.5" y="852.2842">payment-processor</text><rect fill="#FEFECE" filter="url(#f146e7nywmc2wu)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="800.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="807.5" y="70.9951">OCS</text><rect fill="#FEFECE" filter="url(#f146e7nywmc2wu)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="800.5" y="832.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="807.5" y="852.2842">OCS</text><rect fill="#FEFECE" filter="url(#f146e7nywmc2wu)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="858.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="865.5" y="70.9951">DAO</text><rect fill="#FEFECE" filter="url(#f146e7nywmc2wu)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="858.5" y="832.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="865.5" y="852.2842">DAO</text><rect fill="#FEFECE" filter="url(#f146e7nywmc2wu)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="1164.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1171.5" y="70.9951">Stripe</text><rect fill="#FEFECE" filter="url(#f146e7nywmc2wu)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="1164.5" y="832.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1171.5" y="852.2842">Stripe</text><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="718.9922" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="655.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="196.5" y="159.5625"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="314.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="533.5" y="472.0234"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="819.5" y="666.9531"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878.5" y="242.9609"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878.5" y="355.4922"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878.5" y="413.7578"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="41.6992" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878.5" y="583.5547"/><rect fill="#FFFFFF" filter="url(#f146e7nywmc2wu)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1189.5" y="525.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="78.5" y1="117.4297" y2="117.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="78.5" x2="78.5" y1="117.4297" y2="130.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="37.5" x2="78.5" y1="130.4297" y2="130.4297"/><polygon fill="#A80036" points="47.5,126.4297,37.5,130.4297,47.5,134.4297,43.5,130.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="43.5" y="112.3638">Select product ({sku})</text><polygon fill="#A80036" points="184.5,155.5625,194.5,159.5625,184.5,163.5625,188.5,159.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="190.5" y1="159.5625" y2="159.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="43.5" y="154.4966">POST /products {sku}</text><path d="M211,172.5625 L211,212.5625 L540,212.5625 L540,182.5625 L530,172.5625 L211,172.5625 " fill="#FBFB77" filter="url(#f146e7nywmc2wu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M530,172.5625 L530,182.5625 L540,182.5625 L530,172.5625 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="217" y="189.6294">{name} identifies the user (from Oauth2 auth.)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="217" y="204.7622">and is equivalent to the users email address</text><polygon fill="#A80036" points="866.5,238.9609,876.5,242.9609,866.5,246.9609,870.5,242.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="206.5" x2="872.5" y1="242.9609" y2="242.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="213.5" y="237.895">getPaymentId(name)</text><polygon fill="#A80036" points="217.5,268.0938,207.5,272.0938,217.5,276.0938,213.5,272.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="882.5" y1="272.0938" y2="272.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="223.5" y="267.0278">{paymentId}</text><path d="M211,285.0938 L211,325.0938 L680,325.0938 L680,295.0938 L670,285.0938 L211,285.0938 " fill="#FBFB77" filter="url(#f146e7nywmc2wu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M670,285.0938 L670,295.0938 L680,295.0938 L670,285.0938 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="217" y="302.1606">Report an error if {paymentId} does not exists, as a "default source"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="342" x="217" y="317.2935">can not be used without having a valid {paymentId}</text><polygon fill="#A80036" points="866.5,351.4922,876.5,355.4922,866.5,359.4922,870.5,355.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="206.5" x2="872.5" y1="355.4922" y2="355.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="213.5" y="350.4263">getDefaultSource(name)</text><polygon fill="#A80036" points="217.5,380.625,207.5,384.625,217.5,388.625,213.5,384.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="882.5" y1="384.625" y2="384.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="223.5" y="379.5591">{sourceId}</text><polygon fill="#A80036" points="866.5,409.7578,876.5,413.7578,866.5,417.7578,870.5,413.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="206.5" x2="872.5" y1="413.7578" y2="413.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="213.5" y="408.6919">getProduct(sku)</text><polygon fill="#A80036" points="217.5,438.8906,207.5,442.8906,217.5,446.8906,213.5,442.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="882.5" y1="442.8906" y2="442.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="223.5" y="437.8247">{product}</text><polygon fill="#A80036" points="521.5,468.0234,531.5,472.0234,521.5,476.0234,525.5,472.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="206.5" x2="527.5" y1="472.0234" y2="472.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="213.5" y="466.9575">purchaseProduct(paymentId, sourceId, product)</text><path d="M450.5,487.0234 L514.5,487.0234 L514.5,494.0234 L504.5,504.0234 L450.5,504.0234 L450.5,487.0234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="271" style="stroke: #000000; stroke-width: 2.0;" width="784" x="450.5" y="487.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="465.5" y="500.0903">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="529.5" y="499.2339">[successful case]</text><polygon fill="#A80036" points="1177.5,521.2891,1187.5,525.2891,1177.5,529.2891,1181.5,525.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="1183.5" y1="525.2891" y2="525.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="627" x="550.5" y="520.2231">POST /v1/charges {paymentId, sourceId, product.amount, product.currency, product.description}</text><polygon fill="#A80036" points="554.5,550.4219,544.5,554.4219,554.5,558.4219,550.5,554.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="548.5" x2="1193.5" y1="554.4219" y2="554.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="560.5" y="549.356">{chargeInfo}</text><polygon fill="#A80036" points="866.5,579.5547,876.5,583.5547,866.5,587.5547,870.5,583.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="872.5" y1="583.5547" y2="583.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="550.5" y="578.4888">recordChargeInfo(paymentId, chargeInfo)</text><polygon fill="#A80036" points="554.5,621.2539,544.5,625.2539,554.5,629.2539,550.5,625.2539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="548.5" x2="882.5" y1="625.2539" y2="625.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="560.5" y="620.188">{result}</text><path d="M893,596.5547 L893,636.5547 L1118,636.5547 L1118,606.5547 L1108,596.5547 L893,596.5547 " fill="#FBFB77" filter="url(#f146e7nywmc2wu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1108,596.5547 L1108,606.5547 L1118,606.5547 L1108,596.5547 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="899" y="613.6216">Charges/refunds to be recorded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="899" y="628.7544">in a "ledger" type of store</text><polygon fill="#A80036" points="807.5,662.9531,817.5,666.9531,807.5,670.9531,811.5,666.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="813.5" y1="666.9531" y2="666.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="550.5" y="661.8872">updateBucket(paymentId, product.size)</text><polygon fill="#A80036" points="554.5,692.0859,544.5,696.0859,554.5,700.0859,550.5,696.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="548.5" x2="823.5" y1="696.0859" y2="696.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="560.5" y="691.02">{result}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="450.5" x2="1234.5" y1="705.0859" y2="705.0859"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="40" x="455.5" y="715.2964">[error]</text><path d="M548,723.8906 L548,748.8906 L799,748.8906 L799,733.8906 L789,723.8906 L548,723.8906 " fill="#FBFB77" filter="url(#f146e7nywmc2wu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M789,723.8906 L789,733.8906 L799,733.8906 L789,723.8906 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="554" y="740.9575">Unroll charge with Stripe etc. (TBD)</text><polygon fill="#A80036" points="217.5,782.1563,207.5,786.1563,217.5,790.1563,213.5,786.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="211.5" x2="537.5" y1="786.1563" y2="786.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="223.5" y="781.0903">{result}</text><polygon fill="#A80036" points="42.5,811.2891,32.5,815.2891,42.5,819.2891,38.5,815.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="200.5" y1="815.2891" y2="815.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="48.5" y="810.2231">{result}</text><!--
@startuml

actor Client
participant Client

box "Prime"
    participant "client-api"
    participant "payment-processor"
    participant OCS
    participant DAO
end box
participant Stripe

activate Client

    Client -> Client : Select product ({sku})

    Client -> "client-api": POST /products {sku}
    activate "client-api"
    note right of "client-api"
       {name} identifies the user (from Oauth2 auth.)
       and is equivalent to the users email address
    end note

    "client-api" -> DAO : getPaymentId(name)
    activate DAO
    DAO -> "client-api" : {paymentId}
    deactivate DAO

    note right of "client-api"
        Report an error if {paymentId} does not exists, as a "default source"
        can not be used without having a valid {paymentId}
    end note

    "client-api" -> DAO : getDefaultSource(name)
    activate DAO
    DAO -> "client-api" : {sourceId}
    deactivate DAO

    "client-api" -> DAO : getProduct(sku)
    activate DAO
    DAO -> "client-api" : {product}
    deactivate DAO

    "client-api" -> "payment-processor" : purchaseProduct(paymentId, sourceId, product)
    activate "payment-processor"

    alt successful case
        "payment-processor" -> Stripe : POST /v1/charges {paymentId, sourceId, product.amount, product.currency, product.description}
        activate Stripe
        Stripe -> "payment-processor" : {chargeInfo}
        deactivate Stripe

        "payment-processor" -> DAO: recordChargeInfo(paymentId, chargeInfo)
        activate DAO
        DAO -> "payment-processor" : {result}
        deactivate DAO
        note right
          Charges/refunds to be recorded
          in a "ledger" type of store
        end note

        "payment-processor" -> OCS : updateBucket(paymentId, product.size)
        activate OCS
        OCS -> "payment-processor" : {result}
        deactivate OCS

    else error
         note right of "payment-processor" : Unroll charge with Stripe etc. (TBD)

    end

    "payment-processor" -> "client-api" : {result}
    deactivate "payment-processor"

    "client-api" -> Client : {result}
    deactivate "client-api"

deactivate Client

@enduml

PlantUML version 1.2018.08(Sun Jun 24 14:31:00 CEST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_171-8u171-b11-0ubuntu0.17.10.1-b11
Operating System: Linux
OS Version: 4.13.0-46-generic
Default Encoding: UTF-8
Language: nb
Country: NO
--></g></svg>