<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1254px" preserveAspectRatio="none" style="width:1511px;height:1254px;" version="1.1" viewBox="0 0 1511 1254" width="1511px" zoomAndPan="magnify"><defs><filter height="300%" id="f191k2kf2278fb" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="1239.5859" style="stroke: #A80036; stroke-width: 1.0;" width="853" x="314.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="719.5" y="16.0669">Prime</text><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="1042.9922" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="879.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="355.5" y="259.9609"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="471.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="788.5" y="638.3594"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1074.5" y="990.9531"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1133.5" y="343.3594"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1133.5" y="580.0938"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="41.6992" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1133.5" y="907.5547"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1444.5" y="159.5625"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="34.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1444.5" y="691.625"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1444.5" y="759.8906"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1444.5" y="842.2891"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="125.3359" style="stroke: #000000; stroke-width: 2.0;" width="395" x="360" y="387.4922"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="395" x="360" y="458.8906"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="428.6641" style="stroke: #000000; stroke-width: 2.0;" width="1116.5" x="383" y="653.3594"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="784" x="705.5" y="804.0234"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="1116.5" x="383" y="1028.0859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="31" x2="31" y1="86.2969" y2="1157.2891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="360.5" x2="360.5" y1="86.2969" y2="1157.2891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="793.5" x2="793.5" y1="86.2969" y2="1157.2891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1079.5" x2="1079.5" y1="86.2969" y2="1157.2891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1138.5" x2="1138.5" y1="86.2969" y2="1157.2891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1449.5" x2="1449.5" y1="86.2969" y2="1157.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="82.9951">Client</text><ellipse cx="31.5" cy="13" fill="#FEFECE" filter="url(#f191k2kf2278fb)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,21 L31.5,48 M18.5,29 L44.5,29 M31.5,48 L18.5,63 M31.5,48 L44.5,63 " fill="none" filter="url(#f191k2kf2278fb)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="1169.2842">Client</text><ellipse cx="31.5" cy="1182.5859" fill="#FEFECE" filter="url(#f191k2kf2278fb)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,1190.5859 L31.5,1217.5859 M18.5,1198.5859 L44.5,1198.5859 M31.5,1217.5859 L18.5,1232.5859 M31.5,1217.5859 L44.5,1232.5859 " fill="none" filter="url(#f191k2kf2278fb)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f191k2kf2278fb)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="318.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="325.5" y="70.9951">client-api</text><rect fill="#FEFECE" filter="url(#f191k2kf2278fb)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="318.5" y="1156.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="325.5" y="1176.2842">client-api</text><rect fill="#FEFECE" filter="url(#f191k2kf2278fb)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="715.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="722.5" y="70.9951">payment-processor</text><rect fill="#FEFECE" filter="url(#f191k2kf2278fb)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="715.5" y="1156.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="722.5" y="1176.2842">payment-processor</text><rect fill="#FEFECE" filter="url(#f191k2kf2278fb)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="1055.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="1062.5" y="70.9951">OCS</text><rect fill="#FEFECE" filter="url(#f191k2kf2278fb)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="1055.5" y="1156.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="1062.5" y="1176.2842">OCS</text><rect fill="#FEFECE" filter="url(#f191k2kf2278fb)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="1113.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="1120.5" y="70.9951">DAO</text><rect fill="#FEFECE" filter="url(#f191k2kf2278fb)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="1113.5" y="1156.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="1120.5" y="1176.2842">DAO</text><rect fill="#FEFECE" filter="url(#f191k2kf2278fb)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="1419.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1426.5" y="70.9951">Stripe</text><rect fill="#FEFECE" filter="url(#f191k2kf2278fb)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="1419.5" y="1156.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1426.5" y="1176.2842">Stripe</text><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="1042.9922" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="879.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="355.5" y="259.9609"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="471.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="788.5" y="638.3594"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1074.5" y="990.9531"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1133.5" y="343.3594"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1133.5" y="580.0938"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="41.6992" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1133.5" y="907.5547"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1444.5" y="159.5625"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="34.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1444.5" y="691.625"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1444.5" y="759.8906"/><rect fill="#FFFFFF" filter="url(#f191k2kf2278fb)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1444.5" y="842.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="78.5" y1="117.4297" y2="117.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="78.5" x2="78.5" y1="117.4297" y2="130.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="37.5" x2="78.5" y1="130.4297" y2="130.4297"/><polygon fill="#A80036" points="47.5,126.4297,37.5,130.4297,47.5,134.4297,43.5,130.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="43.5" y="112.3638">Collecting payment information</text><polygon fill="#A80036" points="1432.5,155.5625,1442.5,159.5625,1432.5,163.5625,1436.5,159.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="1438.5" y1="159.5625" y2="159.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="43.5" y="154.4966">Create new source with Stripe</text><polygon fill="#A80036" points="47.5,184.6953,37.5,188.6953,47.5,192.6953,43.5,188.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="41.5" x2="1448.5" y1="188.6953" y2="188.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="53.5" y="183.6294">{sourceId}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="78.5" y1="217.8281" y2="217.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="78.5" x2="78.5" y1="217.8281" y2="230.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="37.5" x2="78.5" y1="230.8281" y2="230.8281"/><polygon fill="#A80036" points="47.5,226.8281,37.5,230.8281,47.5,234.8281,43.5,230.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="43.5" y="212.7622">Select product ({sku})</text><polygon fill="#A80036" points="343.5,255.9609,353.5,259.9609,343.5,263.9609,347.5,259.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="349.5" y1="259.9609" y2="259.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="43.5" y="254.895">POST /products {sku, sourceId, saveCardFlag}</text><path d="M370,272.9609 L370,312.9609 L699,312.9609 L699,282.9609 L689,272.9609 L370,272.9609 " fill="#FBFB77" filter="url(#f191k2kf2278fb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M689,272.9609 L689,282.9609 L699,282.9609 L689,272.9609 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="376" y="290.0278">{name} identifies the user (from Oauth2 auth.)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="376" y="305.1606">and is equivalent to the users email address</text><polygon fill="#A80036" points="1121.5,339.3594,1131.5,343.3594,1121.5,347.3594,1125.5,343.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="365.5" x2="1127.5" y1="343.3594" y2="343.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="372.5" y="338.2935">getPaymentId(name)</text><polygon fill="#A80036" points="376.5,368.4922,366.5,372.4922,376.5,376.4922,372.5,372.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="370.5" x2="1137.5" y1="372.4922" y2="372.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="382.5" y="367.4263">{paymentId}</text><path d="M360,387.4922 L424,387.4922 L424,394.4922 L414,404.4922 L360,404.4922 L360,387.4922 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="125.3359" style="stroke: #000000; stroke-width: 2.0;" width="395" x="360" y="387.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="375" y="400.5591">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="439" y="399.7026">[{paymentId} is null]</text><path d="M370,409.625 L370,449.625 L741,449.625 L741,419.625 L731,409.625 L370,409.625 " fill="#FBFB77" filter="url(#f191k2kf2278fb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M731,409.625 L731,419.625 L741,419.625 L731,409.625 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="376" y="426.6919">Register subscriber using the "create-new-subscriber"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="376" y="441.8247">flow diagram</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="360" x2="755" y1="459.8906" y2="459.8906"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="365" y="470.1011">[{paymentId} is not null]</text><path d="M370,478.6953 L370,503.6953 L582,503.6953 L582,488.6953 L572,478.6953 L370,478.6953 " fill="#FBFB77" filter="url(#f191k2kf2278fb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M572,478.6953 L572,488.6953 L582,488.6953 L572,478.6953 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="376" y="495.7622">Subscriber already registered</text><path d="M370,524.8281 L370,549.8281 L740,549.8281 L740,534.8281 L730,524.8281 L370,524.8281 " fill="#FBFB77" filter="url(#f191k2kf2278fb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M730,524.8281 L730,534.8281 L740,534.8281 L730,524.8281 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="349" x="376" y="541.895">At this point there is a valid {paymentId} for {name}</text><polygon fill="#A80036" points="1121.5,576.0938,1131.5,580.0938,1121.5,584.0938,1125.5,580.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="365.5" x2="1127.5" y1="580.0938" y2="580.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="372.5" y="575.0278">getProduct(sku)</text><polygon fill="#A80036" points="376.5,605.2266,366.5,609.2266,376.5,613.2266,372.5,609.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="370.5" x2="1137.5" y1="609.2266" y2="609.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="382.5" y="604.1606">{product}</text><polygon fill="#A80036" points="776.5,634.3594,786.5,638.3594,776.5,642.3594,780.5,638.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="365.5" x2="782.5" y1="638.3594" y2="638.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="372.5" y="633.2935">purchaseProduct(paymentId, sourceId, product, saveCardFlag)</text><path d="M383,653.3594 L447,653.3594 L447,660.3594 L437,670.3594 L383,670.3594 L383,653.3594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="428.6641" style="stroke: #000000; stroke-width: 2.0;" width="1116.5" x="383" y="653.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="398" y="666.4263">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="462" y="665.5698">[successful case]</text><polygon fill="#A80036" points="1432.5,687.625,1442.5,691.625,1432.5,695.625,1436.5,691.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="798.5" x2="1438.5" y1="691.625" y2="691.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="349" x="805.5" y="686.5591">POST /v1/customers/{paymentId}/sources {sourceId}</text><polygon fill="#A80036" points="809.5,721.7578,799.5,725.7578,809.5,729.7578,805.5,725.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="803.5" x2="1448.5" y1="725.7578" y2="725.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="815.5" y="720.6919">{sourceInfo}</text><path d="M393,704.625 L393,729.625 L779,729.625 L779,714.625 L769,704.625 L393,704.625 " fill="#FBFB77" filter="url(#f191k2kf2278fb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M769,704.625 L769,714.625 L779,714.625 L769,704.625 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="365" x="399" y="721.6919">Attach new source to customer ({sourceId, paymentId})</text><polygon fill="#A80036" points="1432.5,755.8906,1442.5,759.8906,1432.5,763.8906,1436.5,759.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="798.5" x2="1438.5" y1="759.8906" y2="759.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="627" x="805.5" y="754.8247">POST /v1/charges {paymentId, sourceId, product.amount, product.currency, product.description}</text><polygon fill="#A80036" points="809.5,785.0234,799.5,789.0234,809.5,793.0234,805.5,789.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="803.5" x2="1448.5" y1="789.0234" y2="789.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="815.5" y="783.9575">{chargeInfo}</text><path d="M705.5,804.0234 L769.5,804.0234 L769.5,811.0234 L759.5,821.0234 L705.5,821.0234 L705.5,804.0234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="784" x="705.5" y="804.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="720.5" y="817.0903">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="142" x="784.5" y="816.2339">[saveCardFlag is false]</text><polygon fill="#A80036" points="1432.5,838.2891,1442.5,842.2891,1432.5,846.2891,1436.5,842.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="798.5" x2="1438.5" y1="842.2891" y2="842.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="805.5" y="837.2231">DELETE /v1/customer/{paymentId}/sources/{sourceId}</text><polygon fill="#A80036" points="809.5,867.4219,799.5,871.4219,809.5,875.4219,805.5,871.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="803.5" x2="1448.5" y1="871.4219" y2="871.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="815.5" y="866.356">{result)}</text><polygon fill="#A80036" points="1121.5,903.5547,1131.5,907.5547,1121.5,911.5547,1125.5,907.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="798.5" x2="1127.5" y1="907.5547" y2="907.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="805.5" y="902.4888">recordChargeInfo(paymentId, chargeInfo)</text><polygon fill="#A80036" points="809.5,945.2539,799.5,949.2539,809.5,953.2539,805.5,949.2539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="803.5" x2="1137.5" y1="949.2539" y2="949.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="815.5" y="944.188">{result}</text><path d="M1148,920.5547 L1148,960.5547 L1373,960.5547 L1373,930.5547 L1363,920.5547 L1148,920.5547 " fill="#FBFB77" filter="url(#f191k2kf2278fb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1363,920.5547 L1363,930.5547 L1373,930.5547 L1363,920.5547 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1154" y="937.6216">Charges/refunds to be recorded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="1154" y="952.7544">in a "ledger" type of store</text><polygon fill="#A80036" points="1062.5,986.9531,1072.5,990.9531,1062.5,994.9531,1066.5,990.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="798.5" x2="1068.5" y1="990.9531" y2="990.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="805.5" y="985.8872">updateBucket(paymentId, product.size)</text><polygon fill="#A80036" points="809.5,1016.0859,799.5,1020.0859,809.5,1024.0859,805.5,1020.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="803.5" x2="1078.5" y1="1020.0859" y2="1020.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="815.5" y="1015.02">{result}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="383" x2="1499.5" y1="1029.0859" y2="1029.0859"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="40" x="388" y="1039.2964">[error]</text><path d="M803,1047.8906 L803,1072.8906 L1054,1072.8906 L1054,1057.8906 L1044,1047.8906 L803,1047.8906 " fill="#FBFB77" filter="url(#f191k2kf2278fb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1044,1047.8906 L1044,1057.8906 L1054,1057.8906 L1044,1047.8906 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="809" y="1064.9575">Unroll charge with Stripe etc. (TBD)</text><polygon fill="#A80036" points="376.5,1106.1563,366.5,1110.1563,376.5,1114.1563,372.5,1110.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="370.5" x2="792.5" y1="1110.1563" y2="1110.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="382.5" y="1105.0903">{result}</text><polygon fill="#A80036" points="42.5,1135.2891,32.5,1139.2891,42.5,1143.2891,38.5,1139.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="359.5" y1="1139.2891" y2="1139.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="48.5" y="1134.2231">{result}</text><!--
@startuml

actor Client
participant Client

box "Prime"
    participant "client-api"
    participant "payment-processor"
    participant OCS
    participant DAO
end box
participant Stripe

activate Client
    Client -> Client : Collecting payment information

    Client -> Stripe : Create new source with Stripe
    activate Stripe
    Stripe -> Client : {sourceId}
    deactivate Stripe

    Client -> Client : Select product ({sku})

    Client -> "client-api": POST /products {sku, sourceId, saveCardFlag}
    activate "client-api"
    note right of "client-api"
       {name} identifies the user (from Oauth2 auth.)
       and is equivalent to the users email address
    end note

    "client-api" -> DAO : getPaymentId(name)
    activate DAO
    DAO -> "client-api" : {paymentId}
    deactivate DAO

    alt {paymentId} is null
        note right of "client-api"
            Register subscriber using the "create-new-subscriber"
            flow diagram
        end note
    else {paymentId} is not null
        note right of "client-api"
            Subscriber already registered
        end note
    end
    note right of "client-api"
        At this point there is a valid {paymentId} for {name}
    end note

    "client-api" -> DAO : getProduct(sku)
    activate DAO
    DAO -> "client-api" : {product}
    deactivate DAO

    "client-api" -> "payment-processor" : purchaseProduct(paymentId, sourceId, product, saveCardFlag)
    activate "payment-processor"

    alt successful case

        "payment-processor" -> Stripe : POST /v1/customers/{paymentId}/sources {sourceId}
        activate Stripe
        Stripe -> "payment-processor" : {sourceInfo}
        deactivate Stripe
        note left : Attach new source to customer ({sourceId, paymentId})

        "payment-processor" -> Stripe : POST /v1/charges {paymentId, sourceId, product.amount, product.currency, product.description}
        activate Stripe
        Stripe -> "payment-processor" : {chargeInfo}
        deactivate Stripe

        alt saveCardFlag is false
            "payment-processor" -> Stripe : DELETE /v1/customer/{paymentId}/sources/{sourceId}
             activate Stripe
            Stripe -> "payment-processor" : {result)}
            deactivate Stripe
        end

        "payment-processor" -> DAO: recordChargeInfo(paymentId, chargeInfo)
        activate DAO
        DAO -> "payment-processor" : {result}
        deactivate DAO
        note right
          Charges/refunds to be recorded
          in a "ledger" type of store
        end note

        "payment-processor" -> OCS : updateBucket(paymentId, product.size)
        activate OCS
        OCS -> "payment-processor" : {result}
        deactivate OCS

    else error
         note right of "payment-processor" : Unroll charge with Stripe etc. (TBD)

    end

    "payment-processor" -> "client-api" : {result}
    deactivate "payment-processor"

    "client-api" -> Client : {result}
    deactivate "client-api"

deactivate Client

@enduml

PlantUML version 1.2018.08(Sun Jun 24 14:31:00 CEST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_171-8u171-b11-0ubuntu0.17.10.1-b11
Operating System: Linux
OS Version: 4.13.0-46-generic
Default Encoding: UTF-8
Language: nb
Country: NO
--></g></svg>