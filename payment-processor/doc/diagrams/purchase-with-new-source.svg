<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1076px" preserveAspectRatio="none" style="width:1455px;height:1076px;" version="1.1" viewBox="0 0 1455 1076" width="1455px" zoomAndPan="magnify"><defs><filter height="300%" id="f1bh6gfggi2dke" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="1061.1172" style="stroke: #A80036; stroke-width: 1.0;" width="761" x="314.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="673.5" y="16.0669">Prime</text><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="864.5234" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="700.8594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="355.5" y="259.9609"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="588.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="729.5" y="343.3594"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="982.5" y="812.4844"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1041.5" y="372.4922"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1041.5" y="430.7578"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="41.6992" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1041.5" y="729.0859"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1388.5" y="159.5625"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="34.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1388.5" y="513.1563"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1388.5" y="581.4219"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1388.5" y="663.8203"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="428.6641" style="stroke: #000000; stroke-width: 2.0;" width="1122.5" x="321" y="474.8906"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="787" x="646.5" y="625.5547"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="1122.5" x="321" y="849.6172"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="31" x2="31" y1="86.2969" y2="978.8203"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="360.5" x2="360.5" y1="86.2969" y2="978.8203"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="734.5" x2="734.5" y1="86.2969" y2="978.8203"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="987.5" x2="987.5" y1="86.2969" y2="978.8203"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1046.5" x2="1046.5" y1="86.2969" y2="978.8203"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1393.5" x2="1393.5" y1="86.2969" y2="978.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="82.9951">Client</text><ellipse cx="31.5" cy="13" fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,21 L31.5,48 M18.5,29 L44.5,29 M31.5,48 L18.5,63 M31.5,48 L44.5,63 " fill="none" filter="url(#f1bh6gfggi2dke)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="990.8154">Client</text><ellipse cx="31.5" cy="1004.1172" fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,1012.1172 L31.5,1039.1172 M18.5,1020.1172 L44.5,1020.1172 M31.5,1039.1172 L18.5,1054.1172 M31.5,1039.1172 L44.5,1054.1172 " fill="none" filter="url(#f1bh6gfggi2dke)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="318.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="325.5" y="70.9951">client-api</text><rect fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="318.5" y="977.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="325.5" y="997.8154">client-api</text><rect fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="656.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="663.5" y="70.9951">payment-processor</text><rect fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="656.5" y="977.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="663.5" y="997.8154">payment-processor</text><rect fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="963.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="970.5" y="70.9951">OCS</text><rect fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="963.5" y="977.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="970.5" y="997.8154">OCS</text><rect fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="1021.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="1028.5" y="70.9951">DAO</text><rect fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="1021.5" y="977.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="1028.5" y="997.8154">DAO</text><rect fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="1363.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1370.5" y="70.9951">Stripe</text><rect fill="#FEFECE" filter="url(#f1bh6gfggi2dke)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="1363.5" y="977.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1370.5" y="997.8154">Stripe</text><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="864.5234" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="700.8594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="355.5" y="259.9609"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="588.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="729.5" y="343.3594"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="982.5" y="812.4844"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1041.5" y="372.4922"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1041.5" y="430.7578"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="41.6992" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1041.5" y="729.0859"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1388.5" y="159.5625"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="34.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1388.5" y="513.1563"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1388.5" y="581.4219"/><rect fill="#FFFFFF" filter="url(#f1bh6gfggi2dke)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1388.5" y="663.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="78.5" y1="117.4297" y2="117.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="78.5" x2="78.5" y1="117.4297" y2="130.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="37.5" x2="78.5" y1="130.4297" y2="130.4297"/><polygon fill="#A80036" points="47.5,126.4297,37.5,130.4297,47.5,134.4297,43.5,130.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="43.5" y="112.3638">Collecting payment information</text><polygon fill="#A80036" points="1376.5,155.5625,1386.5,159.5625,1376.5,163.5625,1380.5,159.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="1382.5" y1="159.5625" y2="159.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="43.5" y="154.4966">Create new source with Stripe</text><polygon fill="#A80036" points="47.5,184.6953,37.5,188.6953,47.5,192.6953,43.5,188.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="41.5" x2="1392.5" y1="188.6953" y2="188.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="53.5" y="183.6294">{sourceId}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="78.5" y1="217.8281" y2="217.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="78.5" x2="78.5" y1="217.8281" y2="230.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="37.5" x2="78.5" y1="230.8281" y2="230.8281"/><polygon fill="#A80036" points="47.5,226.8281,37.5,230.8281,47.5,234.8281,43.5,230.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="43.5" y="212.7622">Select product ({sku})</text><polygon fill="#A80036" points="343.5,255.9609,353.5,259.9609,343.5,263.9609,347.5,259.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="349.5" y1="259.9609" y2="259.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="43.5" y="254.895">POST /products {sku, sourceId, saveCardFlag}</text><path d="M370,272.9609 L370,312.9609 L699,312.9609 L699,282.9609 L689,272.9609 L370,272.9609 " fill="#FBFB77" filter="url(#f1bh6gfggi2dke)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M689,272.9609 L689,282.9609 L699,282.9609 L689,272.9609 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="376" y="290.0278">{name} identifies the user (from Oauth2 auth.)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="376" y="305.1606">and is equivalent to the users email address</text><polygon fill="#A80036" points="717.5,339.3594,727.5,343.3594,717.5,347.3594,721.5,343.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="365.5" x2="723.5" y1="343.3594" y2="343.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="372.5" y="338.2935">purchaseProduct(name, sku, sourceId, saveCardFlag)</text><polygon fill="#A80036" points="1029.5,368.4922,1039.5,372.4922,1029.5,376.4922,1033.5,372.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="739.5" x2="1035.5" y1="372.4922" y2="372.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="746.5" y="367.4263">getStripeCustomerId(name)</text><polygon fill="#A80036" points="750.5,397.625,740.5,401.625,750.5,405.625,746.5,401.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="744.5" x2="1045.5" y1="401.625" y2="401.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="756.5" y="396.5591">{customerId}</text><polygon fill="#A80036" points="1029.5,426.7578,1039.5,430.7578,1029.5,434.7578,1033.5,430.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="739.5" x2="1035.5" y1="430.7578" y2="430.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="746.5" y="425.6919">getProduct(sku)</text><polygon fill="#A80036" points="750.5,455.8906,740.5,459.8906,750.5,463.8906,746.5,459.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="744.5" x2="1045.5" y1="459.8906" y2="459.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="756.5" y="454.8247">{product}</text><path d="M321,474.8906 L385,474.8906 L385,481.8906 L375,491.8906 L321,491.8906 L321,474.8906 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="428.6641" style="stroke: #000000; stroke-width: 2.0;" width="1122.5" x="321" y="474.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="336" y="487.9575">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="400" y="487.1011">[successful case]</text><polygon fill="#A80036" points="1376.5,509.1563,1386.5,513.1563,1376.5,517.1563,1380.5,513.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="739.5" x2="1382.5" y1="513.1563" y2="513.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="746.5" y="508.0903">POST /v1/customers/{customerId}/sources {sourceId}</text><polygon fill="#A80036" points="750.5,543.2891,740.5,547.2891,750.5,551.2891,746.5,547.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="744.5" x2="1392.5" y1="547.2891" y2="547.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="756.5" y="542.2231">{sourceInfo}</text><path d="M331,526.1563 L331,551.1563 L720,551.1563 L720,536.1563 L710,526.1563 L331,526.1563 " fill="#FBFB77" filter="url(#f1bh6gfggi2dke)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M710,526.1563 L710,536.1563 L720,536.1563 L710,526.1563 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="337" y="543.2231">Attach new source to customer ({sourceId, customerId})</text><polygon fill="#A80036" points="1376.5,577.4219,1386.5,581.4219,1376.5,585.4219,1380.5,581.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="739.5" x2="1382.5" y1="581.4219" y2="581.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="630" x="746.5" y="576.356">POST /v1/charges {customerId, sourceId, product.amount, product.currency, product.description}</text><polygon fill="#A80036" points="750.5,606.5547,740.5,610.5547,750.5,614.5547,746.5,610.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="744.5" x2="1392.5" y1="610.5547" y2="610.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="756.5" y="605.4888">{chargeInfo}</text><path d="M646.5,625.5547 L710.5,625.5547 L710.5,632.5547 L700.5,642.5547 L646.5,642.5547 L646.5,625.5547 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="787" x="646.5" y="625.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="661.5" y="638.6216">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="142" x="725.5" y="637.7651">[saveCardFlag is false]</text><polygon fill="#A80036" points="1376.5,659.8203,1386.5,663.8203,1376.5,667.8203,1380.5,663.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="739.5" x2="1382.5" y1="663.8203" y2="663.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="746.5" y="658.7544">DELETE /v1/customer/{customerId}/sources/{sourceId}</text><polygon fill="#A80036" points="750.5,688.9531,740.5,692.9531,750.5,696.9531,746.5,692.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="744.5" x2="1392.5" y1="692.9531" y2="692.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="756.5" y="687.8872">{result)}</text><polygon fill="#A80036" points="1029.5,725.0859,1039.5,729.0859,1029.5,733.0859,1033.5,729.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="739.5" x2="1035.5" y1="729.0859" y2="729.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="746.5" y="724.02">recordChargeInfo(name, chargeInfo)</text><polygon fill="#A80036" points="750.5,766.7852,740.5,770.7852,750.5,774.7852,746.5,770.7852" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="744.5" x2="1045.5" y1="770.7852" y2="770.7852"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="756.5" y="765.7192">{result}</text><path d="M1056,742.0859 L1056,782.0859 L1281,782.0859 L1281,752.0859 L1271,742.0859 L1056,742.0859 " fill="#FBFB77" filter="url(#f1bh6gfggi2dke)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1271,742.0859 L1271,752.0859 L1281,752.0859 L1271,742.0859 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1062" y="759.1528">Charges/refunds to be recorded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="1062" y="774.2856">in a "ledger" type of store</text><polygon fill="#A80036" points="970.5,808.4844,980.5,812.4844,970.5,816.4844,974.5,812.4844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="739.5" x2="976.5" y1="812.4844" y2="812.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="746.5" y="807.4185">updateBucket(name, product.size)</text><polygon fill="#A80036" points="750.5,837.6172,740.5,841.6172,750.5,845.6172,746.5,841.6172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="744.5" x2="986.5" y1="841.6172" y2="841.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="756.5" y="836.5513">{result}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="321" x2="1443.5" y1="850.6172" y2="850.6172"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="40" x="326" y="860.8276">[error]</text><path d="M744,869.4219 L744,894.4219 L995,894.4219 L995,879.4219 L985,869.4219 L744,869.4219 " fill="#FBFB77" filter="url(#f1bh6gfggi2dke)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M985,869.4219 L985,879.4219 L995,879.4219 L985,869.4219 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="750" y="886.4888">Unroll charge with Stripe etc. (TBD)</text><polygon fill="#A80036" points="376.5,927.6875,366.5,931.6875,376.5,935.6875,372.5,931.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="370.5" x2="733.5" y1="931.6875" y2="931.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="382.5" y="926.6216">{result}</text><polygon fill="#A80036" points="42.5,956.8203,32.5,960.8203,42.5,964.8203,38.5,960.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="359.5" y1="960.8203" y2="960.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="48.5" y="955.7544">{result}</text><!--
@startuml

actor Client
participant Client

box "Prime"
    participant "client-api"
    participant "payment-processor"
    participant OCS
    participant DAO
end box
participant Stripe

activate Client
    Client -> Client : Collecting payment information

    Client -> Stripe : Create new source with Stripe
    activate Stripe
    Stripe -> Client : {sourceId}
    deactivate Stripe

    Client -> Client : Select product ({sku})

    Client -> "client-api": POST /products {sku, sourceId, saveCardFlag}
    activate "client-api"
    note right of "client-api"
       {name} identifies the user (from Oauth2 auth.)
       and is equivalent to the users email address
    end note

    "client-api" -> "payment-processor" : purchaseProduct(name, sku, sourceId, saveCardFlag)
    activate "payment-processor"

    "payment-processor" -> DAO : getStripeCustomerId(name)
    activate DAO
    DAO -> "payment-processor" : {customerId}
    deactivate DAO

    "payment-processor" -> DAO : getProduct(sku)
    activate DAO
    DAO -> "payment-processor" : {product}
    deactivate DAO

    alt successful case

        "payment-processor" -> Stripe : POST /v1/customers/{customerId}/sources {sourceId}
        activate Stripe
        Stripe -> "payment-processor" : {sourceInfo}
        deactivate Stripe
        note left : Attach new source to customer ({sourceId, customerId})

        "payment-processor" -> Stripe : POST /v1/charges {customerId, sourceId, product.amount, product.currency, product.description}
        activate Stripe
        Stripe -> "payment-processor" : {chargeInfo}
        deactivate Stripe

        alt saveCardFlag is false
            "payment-processor" -> Stripe : DELETE /v1/customer/{customerId}/sources/{sourceId}
             activate Stripe
            Stripe -> "payment-processor" : {result)}
            deactivate Stripe
        end

        "payment-processor" -> DAO: recordChargeInfo(name, chargeInfo)
        activate DAO
        DAO -> "payment-processor" : {result}
        deactivate DAO
        note right
          Charges/refunds to be recorded
          in a "ledger" type of store
        end note

        "payment-processor" -> OCS : updateBucket(name, product.size)
        activate OCS
        OCS -> "payment-processor" : {result}
        deactivate OCS

    else error
         note right of "payment-processor" : Unroll charge with Stripe etc. (TBD)

    end

    "payment-processor" -> "client-api" : {result}
    deactivate "payment-processor"

    "client-api" -> Client : {result}
    deactivate "client-api"

deactivate Client

@enduml

PlantUML version 1.2018.08(Sun Jun 24 14:31:00 CEST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_171-8u171-b11-0ubuntu0.17.10.1-b11
Operating System: Linux
OS Version: 4.13.0-46-generic
Default Encoding: UTF-8
Language: nb
Country: NO
--></g></svg>