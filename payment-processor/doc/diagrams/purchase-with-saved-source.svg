<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="928px" preserveAspectRatio="none" style="width:1370px;height:928px;" version="1.1" viewBox="0 0 1370 928" width="1370px" zoomAndPan="magnify"><defs><filter height="300%" id="f14fv1jejfdomz" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="913.4531" style="stroke: #A80036; stroke-width: 1.0;" width="763" x="273.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="633.5" y="16.0669">Prime</text><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="716.8594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="34.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="314.5" y="117.4297"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="543.1953" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="314.5" y="269.9609"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="314.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="654.5" y="469.8906"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="943.5" y="664.8203"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1002.5" y="353.3594"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1002.5" y="411.625"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="41.6992" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1002.5" y="581.4219"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1313.5" y="523.1563"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="271" style="stroke: #000000; stroke-width: 2.0;" width="787" x="571.5" y="484.8906"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="787" x="571.5" y="701.9531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="31" x2="31" y1="86.2969" y2="831.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="319.5" x2="319.5" y1="86.2969" y2="831.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="659.5" x2="659.5" y1="86.2969" y2="831.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="948.5" x2="948.5" y1="86.2969" y2="831.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1007.5" x2="1007.5" y1="86.2969" y2="831.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1318.5" x2="1318.5" y1="86.2969" y2="831.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="82.9951">Client</text><ellipse cx="31.5" cy="13" fill="#FEFECE" filter="url(#f14fv1jejfdomz)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,21 L31.5,48 M18.5,29 L44.5,29 M31.5,48 L18.5,63 M31.5,48 L44.5,63 " fill="none" filter="url(#f14fv1jejfdomz)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="8" y="843.1514">Client</text><ellipse cx="31.5" cy="856.4531" fill="#FEFECE" filter="url(#f14fv1jejfdomz)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M31.5,864.4531 L31.5,891.4531 M18.5,872.4531 L44.5,872.4531 M31.5,891.4531 L18.5,906.4531 M31.5,891.4531 L44.5,906.4531 " fill="none" filter="url(#f14fv1jejfdomz)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f14fv1jejfdomz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="277.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="284.5" y="70.9951">client-api</text><rect fill="#FEFECE" filter="url(#f14fv1jejfdomz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="80" x="277.5" y="830.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="284.5" y="850.1514">client-api</text><rect fill="#FEFECE" filter="url(#f14fv1jejfdomz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="581.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="588.5" y="70.9951">payment-processor</text><rect fill="#FEFECE" filter="url(#f14fv1jejfdomz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="581.5" y="830.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="588.5" y="850.1514">payment-processor</text><rect fill="#FEFECE" filter="url(#f14fv1jejfdomz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="924.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="931.5" y="70.9951">OCS</text><rect fill="#FEFECE" filter="url(#f14fv1jejfdomz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="924.5" y="830.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="931.5" y="850.1514">OCS</text><rect fill="#FEFECE" filter="url(#f14fv1jejfdomz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="982.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="989.5" y="70.9951">DAO</text><rect fill="#FEFECE" filter="url(#f14fv1jejfdomz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="982.5" y="830.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="989.5" y="850.1514">DAO</text><rect fill="#FEFECE" filter="url(#f14fv1jejfdomz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="1288.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1295.5" y="70.9951">Stripe</text><rect fill="#FEFECE" filter="url(#f14fv1jejfdomz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="1288.5" y="830.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1295.5" y="850.1514">Stripe</text><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="716.8594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="26.5" y="96.2969"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="34.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="314.5" y="117.4297"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="543.1953" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="314.5" y="269.9609"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="314.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="654.5" y="469.8906"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="943.5" y="664.8203"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1002.5" y="353.3594"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1002.5" y="411.625"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="41.6992" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1002.5" y="581.4219"/><rect fill="#FFFFFF" filter="url(#f14fv1jejfdomz)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1313.5" y="523.1563"/><polygon fill="#A80036" points="302.5,113.4297,312.5,117.4297,302.5,121.4297,306.5,117.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="308.5" y1="117.4297" y2="117.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="43.5" y="112.3638">Get saved sources</text><polygon fill="#A80036" points="47.5,147.5625,37.5,151.5625,47.5,155.5625,43.5,151.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="41.5" x2="318.5" y1="151.5625" y2="151.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="53.5" y="146.4966">{list of sources}</text><path d="M329,130.4297 L329,155.4297 L555,155.4297 L555,140.4297 L545,130.4297 L329,130.4297 " fill="#FBFB77" filter="url(#f14fv1jejfdomz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M545,130.4297 L545,140.4297 L555,140.4297 L545,130.4297 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="335" y="147.4966">See "list-sources" flow diagram</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="78.5" y1="185.6953" y2="185.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="78.5" x2="78.5" y1="185.6953" y2="198.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="37.5" x2="78.5" y1="198.6953" y2="198.6953"/><polygon fill="#A80036" points="47.5,194.6953,37.5,198.6953,47.5,202.6953,43.5,198.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="43.5" y="180.6294">Choose source for payment ({sourceId})</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="78.5" y1="227.8281" y2="227.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="78.5" x2="78.5" y1="227.8281" y2="240.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="37.5" x2="78.5" y1="240.8281" y2="240.8281"/><polygon fill="#A80036" points="47.5,236.8281,37.5,240.8281,47.5,244.8281,43.5,240.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="43.5" y="222.7622">Select product ({sku})</text><polygon fill="#A80036" points="302.5,265.9609,312.5,269.9609,302.5,273.9609,306.5,269.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="308.5" y1="269.9609" y2="269.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="43.5" y="264.895">POST /products {sku, sourceId}</text><path d="M329,282.9609 L329,322.9609 L658,322.9609 L658,292.9609 L648,282.9609 L329,282.9609 " fill="#FBFB77" filter="url(#f14fv1jejfdomz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M648,282.9609 L648,292.9609 L658,292.9609 L648,282.9609 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="335" y="300.0278">{name} identifies the user (from Oauth2 auth.)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="335" y="315.1606">and is equivalent to the users email address</text><polygon fill="#A80036" points="990.5,349.3594,1000.5,353.3594,990.5,357.3594,994.5,353.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="996.5" y1="353.3594" y2="353.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="331.5" y="348.2935">getCustomerId(name)</text><polygon fill="#A80036" points="335.5,378.4922,325.5,382.4922,335.5,386.4922,331.5,382.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329.5" x2="1006.5" y1="382.4922" y2="382.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="341.5" y="377.4263">{customerId}</text><polygon fill="#A80036" points="990.5,407.625,1000.5,411.625,990.5,415.625,994.5,411.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="996.5" y1="411.625" y2="411.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="331.5" y="406.5591">getProduct(sku)</text><polygon fill="#A80036" points="335.5,436.7578,325.5,440.7578,335.5,444.7578,331.5,440.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329.5" x2="1006.5" y1="440.7578" y2="440.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="341.5" y="435.6919">{product}</text><polygon fill="#A80036" points="642.5,465.8906,652.5,469.8906,642.5,473.8906,646.5,469.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="648.5" y1="469.8906" y2="469.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="331.5" y="464.8247">purchaseProduct(customerId, sourceId, product)</text><path d="M571.5,484.8906 L635.5,484.8906 L635.5,491.8906 L625.5,501.8906 L571.5,501.8906 L571.5,484.8906 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="271" style="stroke: #000000; stroke-width: 2.0;" width="787" x="571.5" y="484.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="586.5" y="497.9575">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="650.5" y="497.1011">[successful case]</text><polygon fill="#A80036" points="1301.5,519.1563,1311.5,523.1563,1301.5,527.1563,1305.5,523.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="664.5" x2="1307.5" y1="523.1563" y2="523.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="630" x="671.5" y="518.0903">POST /v1/charges {customerId, sourceId, product.amount, product.currency, product.description}</text><polygon fill="#A80036" points="675.5,548.2891,665.5,552.2891,675.5,556.2891,671.5,552.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="669.5" x2="1317.5" y1="552.2891" y2="552.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="681.5" y="547.2231">{chargeInfo}</text><polygon fill="#A80036" points="990.5,577.4219,1000.5,581.4219,990.5,585.4219,994.5,581.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="664.5" x2="996.5" y1="581.4219" y2="581.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="671.5" y="576.356">recordChargeInfo(customerId, chargeInfo)</text><polygon fill="#A80036" points="675.5,619.1211,665.5,623.1211,675.5,627.1211,671.5,623.1211" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="669.5" x2="1006.5" y1="623.1211" y2="623.1211"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="681.5" y="618.0552">{result}</text><path d="M1017,594.4219 L1017,634.4219 L1242,634.4219 L1242,604.4219 L1232,594.4219 L1017,594.4219 " fill="#FBFB77" filter="url(#f14fv1jejfdomz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1232,594.4219 L1232,604.4219 L1242,604.4219 L1232,594.4219 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1023" y="611.4888">Charges/refunds to be recorded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="1023" y="626.6216">in a "ledger" type of store</text><polygon fill="#A80036" points="931.5,660.8203,941.5,664.8203,931.5,668.8203,935.5,664.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="664.5" x2="937.5" y1="664.8203" y2="664.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="671.5" y="659.7544">updateBucket(customerId, product.size)</text><polygon fill="#A80036" points="675.5,689.9531,665.5,693.9531,675.5,697.9531,671.5,693.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="669.5" x2="947.5" y1="693.9531" y2="693.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="681.5" y="688.8872">{result}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="571.5" x2="1358.5" y1="702.9531" y2="702.9531"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="40" x="576.5" y="713.1636">[error]</text><path d="M669,721.7578 L669,746.7578 L920,746.7578 L920,731.7578 L910,721.7578 L669,721.7578 " fill="#FBFB77" filter="url(#f14fv1jejfdomz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M910,721.7578 L910,731.7578 L920,731.7578 L910,721.7578 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="675" y="738.8247">Unroll charge with Stripe etc. (TBD)</text><polygon fill="#A80036" points="335.5,780.0234,325.5,784.0234,335.5,788.0234,331.5,784.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329.5" x2="658.5" y1="784.0234" y2="784.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="341.5" y="778.9575">{result}</text><polygon fill="#A80036" points="42.5,809.1563,32.5,813.1563,42.5,817.1563,38.5,813.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="36.5" x2="318.5" y1="813.1563" y2="813.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="48.5" y="808.0903">{result}</text><!--
@startuml

actor Client
participant Client

box "Prime"
    participant "client-api"
    participant "payment-processor"
    participant OCS
    participant DAO
end box
participant Stripe

activate Client

    Client -> "client-api" : Get saved sources
    activate "client-api"
    "client-api" -> Client : {list of sources}
    deactivate "client-api"
    note right : See "list-sources" flow diagram

    Client -> Client : Choose source for payment ({sourceId})
    Client -> Client : Select product ({sku})

    Client -> "client-api": POST /products {sku, sourceId}
    activate "client-api"
    note right of "client-api"
       {name} identifies the user (from Oauth2 auth.)
       and is equivalent to the users email address
    end note

    "client-api" -> DAO : getCustomerId(name)
    activate DAO
    DAO -> "client-api" : {customerId}
    deactivate DAO

    "client-api" -> DAO : getProduct(sku)
    activate DAO
    DAO -> "client-api" : {product}
    deactivate DAO

    "client-api" -> "payment-processor" : purchaseProduct(customerId, sourceId, product)
    activate "payment-processor"

    alt successful case
        "payment-processor" -> Stripe : POST /v1/charges {customerId, sourceId, product.amount, product.currency, product.description}
        activate Stripe
        Stripe -> "payment-processor" : {chargeInfo}
        deactivate Stripe

        "payment-processor" -> DAO: recordChargeInfo(customerId, chargeInfo)
        activate DAO
        DAO -> "payment-processor" : {result}
        deactivate DAO
        note right
          Charges/refunds to be recorded
          in a "ledger" type of store
        end note

        "payment-processor" -> OCS : updateBucket(customerId, product.size)
        activate OCS
        OCS -> "payment-processor" : {result}
        deactivate OCS

    else error
         note right of "payment-processor" : Unroll charge with Stripe etc. (TBD)

    end

    "payment-processor" -> "client-api" : {result}
    deactivate "payment-processor"

    "client-api" -> Client : {result}
    deactivate "client-api"

deactivate Client

@enduml

PlantUML version 1.2018.08(Sun Jun 24 14:31:00 CEST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_171-8u171-b11-0ubuntu0.17.10.1-b11
Operating System: Linux
OS Version: 4.13.0-46-generic
Default Encoding: UTF-8
Language: nb
Country: NO
--></g></svg>